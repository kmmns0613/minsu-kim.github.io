<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Guestbook Dashboard (Private)</title>

<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    max-width: 900px;
    margin: 40px auto;
    padding: 20px;
    line-height: 1.6;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 18px;
  }
  th, td {
    border-bottom: 1px solid #ccc;
    padding: 10px;
    text-align: left;
  }
  tr:hover {
    background: #fffbea;
  }
</style>

</head>
<body>

<h1>Guestbook Messages <br>(Private Only)</h1>
<p>This page shows messages submitted during ASGSR 2025.</p>

<table id="gbTable">
  <thead>
    <tr>
      <th style="width:180px;">Time</th>
      <th style="width:160px;">Name / Affiliation</th>
      <th>Message</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
  const READ_URL =
    "https://script.google.com/macros/s/AKfycbySvwRR8NwB6XS_E-mzcxgGE3PSiEqqRlnzKJX_TaIi2cOwTiTVEqItYGhb4umLjDDK0A/exec?read=true";

  let latestStamp = null;  // 가장 최근 메시지 timestamp 저장

  function formatTimes(timestamp) {
    const date = new Date(timestamp);

    const korea = date.toLocaleString("ko-KR", {
      timeZone: "Asia/Seoul",
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
      hour: "2-digit",
      minute: "2-digit"
    });

    const usa = date.toLocaleString("en-US", {
      timeZone: "America/Phoenix",
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
      hour: "2-digit",
      minute: "2-digit"
    });

    return { korea, usa };
  }

  async function loadData(force = false) {
    const res = await fetch(READ_URL);
    const data = await res.json();   

    const rows = data.slice(1);
    if (rows.length === 0) return;

    const newest = rows[rows.length - 1][0];  // 마지막 행 timestamp

    // 새 메시지가 없으면 업데이트 스킵
    if (!force && latestStamp === newest) {
      console.log("No new messages. Skipping update.");
      return;
    }

    // 새 메시지가 있거나 force=true이면 업데이트 실행
    latestStamp = newest;

    const tbody = document.querySelector("#gbTable tbody");
    tbody.innerHTML = "";

    // 최신순 출력
    rows.reverse().forEach(row => {
      const timestamp = row[0];
      const name = row[1];
      const affiliation = row[2] || "";
      const message = row[3];

      const { korea, usa } = formatTimes(timestamp);

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td style="width:180px;">
          ${korea}<br>
          <span style="font-size:13px; color:#777;">${usa}</span>
        </td>
        <td style="width:160px;">
          ${name}<br>
          <span style="font-size:13px; color:#777;">${affiliation}</span>
        </td>
        <td style="width:auto; max-width:600px; white-space:normal; line-height:1.5;">
          ${message}
        </td>
      `;
      tbody.appendChild(tr);
    });

    console.log("Messages updated.");
  }

  // 최초 1회는 강제로 전체 로딩
  loadData(true);

  // 이후부터는 변화 발생 시에만 업데이트
  async function checkNewMessages() {
    loadData(false);
  }

  setInterval(checkNewMessages, 30000);
</script>

</body>
</html>